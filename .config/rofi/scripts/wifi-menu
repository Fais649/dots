#!/usr/bin/env bash

# Show loading menu immediately
loading_pid=""
show_loading() {
  echo "  Loading networks..." | rofi -dmenu -i -p "Wi-Fi SSID: " &
  loading_pid=$!
}

# Kill the loading menu
kill_loading() {
  if [ -n "$loading_pid" ]; then
    kill "$loading_pid" 2>/dev/null
    wait "$loading_pid" 2>/dev/null
  fi
}

# Show loading menu immediately
show_loading

# Get the current connected SSID (exact match)
current_ssid=$(nmcli -t -f ACTIVE,SSID dev wifi | grep "^yes:" | cut -d: -f2)

# Build and format wifi list
wifi_list=$(
  nmcli --fields "SECURITY,SSID" device wifi list \
    | sed 1d | sed 's/  */ /g' \
    | sed -E "s/WPA*.?\S/ /g" \
    | sed "s/^--/ /g" \
    | sed "s/  //g" \
    | sed "/--/d" \
    | while IFS= read -r line; do
        # Extract SSID (everything after the first space)
        ssid=$(echo "$line" | cut -d' ' -f2-)
        ssid=$(echo "$ssid" | xargs) # Trim spaces

        # Compare against currently connected SSID
        if [[ "$ssid" == "$current_ssid" ]]; then
          # Replace lock icon with * to mark current connection
          echo "${line// /*}"
        else
          echo "$line"
        fi
      done
)

# Check Wi-Fi status (enabled/disabled)
connected=$(nmcli -fields WIFI g)
if [[ "$connected" =~ "enabled" ]]; then
  toggle="󰖪  Disable Wi-Fi"
elif [[ "$connected" =~ "disabled" ]]; then
  toggle="󰖩  Enable Wi-Fi"
fi

# Kill loading menu and show actual results
kill_loading

# Show menu via rofi
chosen_network=$(echo -e "$toggle\n$wifi_list" \
  | awk '!seen[$0]++' \
  | rofi -dmenu -i -selected-row 1 -p "Wi-Fi SSID: ")

read -r chosen_id <<<"${chosen_network:3}"

if [ -z "$chosen_network" ]; then
  exit
elif [ "$chosen_network" = "󰖩  Enable Wi-Fi" ]; then
  nmcli radio wifi on
elif [ "$chosen_network" = "󰖪  Disable Wi-Fi" ]; then
  nmcli radio wifi off
else
  success_message="You are now connected to the Wi-Fi network \"$chosen_id\"."
  saved_connections=$(nmcli -g NAME connection)

  if [[ $(echo "$saved_connections" | grep -w "$chosen_id") = "$chosen_id" ]]; then
    nmcli connection up id "$chosen_id" | grep "successfully" \
      && notify-send "Connection Established" "$success_message"
  else
    if [[ "$chosen_network" =~ "" ]]; then
      wifi_password=$(rofi -dmenu -p "Password: ")
    fi
    nmcli device wifi connect "$chosen_id" password "$wifi_password" | grep "successfully" \
      && notify-send "Connection Established" "$success_message"
  fi
fi
